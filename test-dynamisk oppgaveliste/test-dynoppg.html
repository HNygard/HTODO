<!doctype html>
<html>
  <head>
    <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="jquery-ui-1.8.1.custom.min.js"></script>

    <script type="text/javascript">
next_id = 3;
$(document).ready(function()
{
	$(".task").keyup(TaskKeyup);
	$(".task").keypress(TaskKeypress);
	
	// Debug / temp
	$("#dbdebug").click(function () {
		executeDBQueries();
	});
});

tmp_new_task = new Array();
db_is_running = false;
db_run_again = false;
database_queries = new Array();
function addDBQuery (query)
{
	database_queries[database_queries.length] = query;
	
	// Debug:
	//console.log(database_queries);
	// TODO: remove
	text = "";
	for(i = 0; i < database_queries.length; i++)
	{
		text += database_queries[i] + '<br>';
	}
	$('#dbdebug').text("").append(text);
}

function executeDBQueries (run_after)
{
	if(db_is_running)
	{
		// Run another one right afterwards
		db_run_again = true;
	}
	else
	{
		queryRunStatus(true);
		db_run_after = run_after;
		tmp_arr = new Array();
		for(i=0; i < database_queries.length; i++)
		{
			tmp_arr = 0;
		}
		$.ajax({
			type: "POST",
			url: "test-dynoppg-phpbackend.php",
			data: {queries: database_queries}, // TODO: values
			success: afterDBQueries,
			// TODO:
			// error: function
		});
		database_queries = new Array(); // TODO: dont remove until success
		
		// Debug:
		$('#dbdebug').text('');
	}
}

function afterDBQueries (msg)
{
	queryRunStatus(false);
	//alert( "Data Saved: \n" + msg );
	
	db_run_after(msg);
	
	if(db_run_again)
	{
		executeDBQueries(function () { });
	}
}

function queryRunStatus(is_running)
{
	db_is_running = is_running;
	//alert("Query_is_running: " + db_is_running);
}

function TaskKeyup (e)
{
	if(e.keyCode == 13) // Enter is pressed
	{
		if(db_is_running)
		{
			alert('Database is working. Please wait.');
			return;
		}
		
		// Getting level
		next_level = parseInt($('#task'+$(this).attr('id')+ ' .level').text());
		
		// Getting parent
		parent_id = parseInt($('#task'+$(this).attr('id')+ ' .parent_id').text());
		
		// Getting position
		position = parseInt($('#task'+$(this).attr('id')+ ' .position').text()) + 1;
		
		// Creating task in database and getting id
		addDBQuery('create,parent:'+parent_id+',position:'+position);
		
		executeDBQueries(function (msg)
		{
			thesplit = msg.split("\n");
			for(i = 0; i < thesplit.length; i++)
			{
				innersplit = thesplit[i].split(',');
				action = '';
				new_position = 0;
				new_parent_id = 0;
				new_id = 0;
				for(j = 0; j < innersplit.length; j++)
				{
					innersplit2 = innersplit[j].split(':',2);
					//console.log(innersplit2);
					if(innersplit[j] == 'created' || innersplit[j] == 'updated')
					{
						action = innersplit[j];
					}
					else if(innersplit2[0] == 'position')
					{
						new_position = innersplit2[1];
					}
					else if(innersplit2[0] == 'parent')
					{
						new_parent_id = innersplit2[1];
					}
					else if(innersplit2[0] == 'id')
					{
						new_id = innersplit2[1];
					}
					else
					{
						//console.log("none of the above");
					}
				}
				//console.log('Action: ' + action);
				//console.log('New_position: ' + new_position);
				//console.log('New_parent_id: ' + new_parent_id);
				//console.log('New_id: ' + new_id);
				if(action == 'created')
				{
					// Locate level
					if(new_parent_id != 0)
					{
						new_level = parseInt($('#task'+new_parent_id+' .level').text()) + 1;
					}
					else
					{
						new_level = 1;
					}
					
					// Add after
					// - We first find the parent
					// - After the parent we look at level and position
					add_after = -1;
					if(new_parent_id == 0)
						parent_found = true;
					else
						parent_found = false;
					$('#tasks li').each(function()
					{
						if(parent_found)
						{
							this_id = 0;
							$.each($(this).children('.task'), function () {
								this_id = parseInt($(this).attr('id'));
							});
							this_level = 0;
							$.each($(this).children('.level'), function () {
								this_level = parseInt($(this).text());
							});
							this_position = 0;
							$.each($(this).children('.position'), function () {
								this_position = parseInt($(this).text());
							});
							if(this_level == new_level
								&& this_position < new_position)
							{
								add_after = this_id;
							}
						}
						else
						{
							this_id = 0;
							$.each($(this).children('.task'), function () {
								this_id = parseInt($(this).attr('id'));
							});
							if(this_id == new_parent_id)
							{
								add_after = this_id;
								parent_found = true;
							}
						}
					});
					
					// Make HTML
					html = '<li id="task'+new_id+'" '+
						'style="margin-left: '+(new_level*40)+'px;">'+
						'<div class="sorter">SORT</div>'+
						'<div class="level">'+new_level+'</div>'+
						'<div class="id_display">'+new_id+'</div>' +
						'<div class="parent_id">'+new_parent_id+'</div>' +
						'<div class="position">'+new_position+'</div>' +
						'<div '+
							// TODO: Change ID to something else
							'id="'+new_id+'" '+
							'class="task" '+
							'contenteditable=""'+
						'>Oppgave '+new_id+'</div></li>';
					
					// Add in the right place
					if(add_after == -1)
					{
						alert("No task added. TODO!");
						// Add inside the ul
						//$('#tasks').add(html);
					}
					else
					{
						// Add after the one we detected above
						$('#task'+add_after).after(html);
					}
					
					$('#task'+new_id+' .task').keyup(TaskKeyup);
					$('#task'+new_id+' .task').keypress(TaskKeypress);
					$('#'+new_id).focus(); // TODO: change id for task edit field
					
					updateTask ();
				}
			}
			// TODO: run database (Have been running updateTask())
		});
	}
	else if (e.keyCode == 9) // Tab is pressed
	{
		// Current id
		current_id = $(this).attr('id');
		
		// Finding level
		next_level = parseInt($('#task'+current_id+ ' .level').text());
		if(e.shiftKey)
		{
			if(next_level > 1) // 1 is the lowest level
				next_level--;
		}
		else
			next_level++;
		
		taskSetLevel(current_id, next_level);
	}
	else if (e.keyCode == 38 || e.keyCode == 40) // Up or down
	{
		found_focus = false;
		next = false;
		last_id = 0;
		
		// Find current id
		current_id = parseInt($(this).attr('id'));
		
		$('#tasks li').each(function()
		{
			if(found_focus)
				return;
			
			// Finding id for this task
			this_id = 0;
			$.each($(this).children('.task'), function () {
				this_id = $(this).attr('id');
			});
			if(this_id == 0)
				return; // Error
			
			if(next)
			{
				found_focus = true;
				$('#'+this_id).focus(); // TODO: change id for task edit field
			}
			
			if(e.keyCode == 38) // Up
			{
				if(this_id == current_id)
				{
					found_focus = true;
					$('#'+last_id).focus(); // TODO: change id for task edit field
				}
			}
			else // Down
			{
				if(this_id == current_id)
				{
					next = true;
				}
			}
			
			last_id = this_id;
		});
	}
	else
	{
		$("#tester").text(e.keyCode);
	}
}

function TaskKeypress(e)
{
	if(e.keyCode == 13 || e.keyCode == 9) {
		return false;
	}
}

function taskSetLevel (task_id, task_level)
{

	if(task_level >= 1)
	{
		$('#task'+task_id).css('margin-left', task_level*40+'px');
		$('#task'+task_id+ ' .level').text("").text(task_level);
		
		updateTask();
	}
}

function updateTask ()
{
	last_level = -1;
	
	levels = new Array();
	levels_parent = new Array();
	positions = new Array();
	
	levels[0] = 1;
	levels_parent[0] = 0;
	positions[0] = 0;
	
	// Running through all tasks
	$('#tasks li').each(function()
	{
		// Getting id
		this_id = 0;
		$.each($(this).children('.task'), function () {
			this_id = $(this).attr('id');
		});
		if(this_id == 0)
			return; // Error
		
		// Getting level
		this_level = 0;
		$.each($(this).children('.level'), function () {
			this_level = parseInt($(this).text());
		});
		while(levels.length > 1 && levels[levels.length-1] > this_level-1)
		{
			levels.length--;
			levels_parent.length--;
			positions.length--;
		}
		
		// Is parent changed?
		this_parent_id = 0;
		$.each($(this).children('.parent_id'), function () {
			this_parent_id = parseInt($(this).text());
		});
		if(this_parent_id != levels_parent[levels_parent.length-1])
		{
			$('#task'+this_id+ ' .parent_id').text(levels_parent[levels_parent.length-1]);
			addDBQuery('update,id:'+this_id+',parent:'+levels_parent[levels_parent.length-1]);
		}
		
		// Is position changed?
		positions[levels.length-1]++;
		this_position = 0;
		$.each($(this).children('.position'), function () {
			this_position = parseInt($(this).text());
		});
		if(this_position != positions[levels.length-1])
		{
			$(this).children('.position').text(positions[levels.length-1]);
			addDBQuery('update,id:'+this_id+',position:'+positions[levels.length-1]);
		}
		
		// Setting parent for further use
		levels_parent[levels.length]  = this_id;
		positions[levels.length]      = 0;
		levels[levels.length]         = this_level;
	});
}

</script>

<style>
li {
 border: 1px solid black;
}

.level
{
	background-color: lightblue;
	width: 70px;
	float: right;
	#display: none;
}
.id_display
{
	background-color: pink;
	width: 130px;
	float: right;
}
.parent_id
{
	background-color: lightgreen;
	width: 130px;
	float: right;
}
.position
{
	background-color: yellow;
	width: 70px;
	float: right;
}
.task { border: 1px solid black; margin: 5px; padding: 5px; width: 400px;}
</style>
<style type="text/css">
#tasks
{
	list-style-type: none;
	margin: 0;
	padding: 0;
	width: 80%;
}
#tasks li
{
	margin: 0 5px 5px 5px;
	padding: 5px;
	font-size: 1.1em;
	height: 1.5em;
}
html>body #tasks li
{
	height: 1.5em;
	line-height: 1.2em;
}
.ui-state-highlight
{
	height: 1.5em;
	line-height: 1.2em;
}
.sorter
{
	display: inline;
}
.task
{
	position: relative;
	top: 3px;
	display: inline;
}
</style>
<script type="text/javascript">
$(function() {
	$("#tasks").sortable({
		placeholder: 'ui-state-highlight',
		distance: 10,
		handle: 'div.sorter',
		update: function() {
			updateTask ();
		}
	});
	//$("#tasks").disableSelection();
});
</script>

  </head>
  <body>
<div id="tester"></div>
<div class="level">Level</div><br>
<div class="id_display">Id</div><br>
<div class="parent_id">Parentid</div><br>
<div class="position">Posisjon</div>
<ul id="tasks">
	<li id="task1" style="margin-left: 40px;"><div class="sorter">SORT</div><div class="level">1</div><div class="id_display">1</div><div class="parent_id">0</div><div class="position">1</div><div class="task" id="1" contenteditable="">Oppgave</div></li>
	<li id="task2" style="margin-left: 40px;"><div class="sorter">SORT</div><div class="level">1</div><div class="id_display">2</div><div class="parent_id">0</div><div class="position">2</div><div class="task" id="2" contenteditable="">Oppgave 2</div></li>
</ul>

<div id="dbdebug"></div>
</body>
</html>
