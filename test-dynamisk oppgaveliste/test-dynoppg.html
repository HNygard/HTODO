<!doctype html>
<html>
  <head>
    <script type="text/javascript" src="jquery-1.4.2.min.js"></script>

    <script type="text/javascript">
next_id = 3;
$(document).ready(function()
{
	$(".task").keyup(TaskKeyup);
	$(".task").keypress(TaskKeypress);
	/*$(".task").keydown(function(e)
	{
		//$("#tester").text(e.keyCode);
	});
	*/
});

function TaskKeyup (e)
{
	if(e.keyCode == 13) // Enter is pressed
	{
		$("#tester").text("aight");
		// Get next id from database
		// TODO: database
	
		// Getting level
		next_level = parseInt($('#task'+$(this).attr('id')+ ' .level').text());
		
		// Getting parent
		parent_id = parseInt($('#task'+$(this).attr('id')+ ' .parent_id').text());
	
		// In with the new task
		$('#task'+$(this).attr('id')).after('<tr id="task'+next_id+'"><td '+
			'style="padding-left: '+(next_level*40)+'px;">'+
			'<div class="level">'+next_level+'</div>'+
			'<div class="id_display">'+next_id+'</div>' +
			'<div class="parent_id">'+parent_id+'</div>' +
			'<div '+
				'id="'+next_id+'" '+
				'class="task" '+
				'contenteditable=""'+
			'>Oppgave '+next_id+'</div></td></tr>');
		// TODO: database
		
		$('#task'+next_id+' .task').keyup(TaskKeyup);
		$('#task'+next_id+' .task').keypress(TaskKeypress);
		$('#'+next_id).focus();
		next_id++;
	}
	else if (e.keyCode == 9) // Tab is pressed
	{
		// Debug:
		$("#tester").text("tab, shift? "+e.shiftKey);
		
		// Current id
		current_id = $(this).attr('id');
		
		// Finding level
		next_level = parseInt($('#task'+current_id+ ' .level').text());
		if(e.shiftKey)
		{
			if(next_level > 1) // 1 is the lowest level
				next_level--;
		}
		else
			next_level++;
		
		taskSetLevel(current_id, next_level);
	}
	else
	{
		$("#tester").text(e.keyCode);
	}
}

function TaskKeypress(e)
{
	if(e.keyCode == 13 || e.keyCode == 9) {
		return false;
	}
}

function taskSetLevel (task_id, task_level)
{
	last_parent_id = 0;
	$('#task'+task_id+' .parent_id').each(function () {
		last_parent_id = parseInt($(this).text());
	});
	
	// Finding parent
	if(task_level > 1)
	{
		// Need a parent since we are not on level 1
		
		parent_id = 0;
		hit_task = false;
		task_children = new Array(); // Saving all children of our task
		
		// Running through all tasks
		$('#tasks td').each(function()
		{
			
			// Getting id
			this_id = 0;
			$.each($(this).children('.task'), function () {
				this_id = $(this).attr('id');
			});
			if(this_id == 0)
				return; // Error
			
			// Checking if this is a children of our task
			$(this).children('.parent_id').each(function () {
				this_parent_id = parseInt($(this).text());
				if(
					this_parent_id == task_id
				)
				{
					// Children of task_id
					task_children[task_children.length] = this_id;
				}
			});
			
			if(hit_task)
				return; // Already found result, no need to go further
		
			if(this_id == task_id)
			{
				// Last parent is parent
				hit_task = true;
				return;
			}
		
			// Getting level
			this_level = 0;
			$.each($(this).children('.level'), function () {
				this_level = parseInt($(this).text());
			});
		
			if(this_level < task_level)
			{
				// Possible parent
				$.each($(this).children('.task'), function () {
					parent_id = parseInt($(this).attr('id'));
				});
			}
			/*else if(this_level == task_level-1)
			{
				parent_id = 0;
				console.log('Resetting parent');
			}
			else
				console.log('None of the above');*/
		});
	
		if(!hit_task || parent_id == 0)
		{
			parent_id_set = false;
		}
		else
			parent_id_set = true;
	}
	else
	{
		// No parent needed, we are on level 1
		parent_id = 0;
		parent_id_set = true;
	}

	if(parent_id != 0 || task_level == 1)
	{
		$('#task'+task_id+ ' td').css('padding-left', task_level*40+'px');
		$('#task'+task_id+ ' .level').text(task_level);
	}
	if(parent_id_set)
	{
		// TODO: database
		$('#task'+task_id+ ' .parent_id').text(parent_id);
		
		// Also check all children
		for(i = 0; i < task_children.length; i++)
		{
			taskCheckParent(task_children[i]);
		}
		// Also check all children of our last parent
		$('#tasks td').each(function()
		{
			
			// Getting id
			this_id = 0;
			$.each($(this).children('.task'), function () {
				this_id = $(this).attr('id');
			});
			if(this_id == 0)
				return; // Error
			
			// Checking if this is a children of our task
			$(this).children('.parent_id').each(function () {
				this_parent_id = parseInt($(this).text());
				if (
					this_parent_id == last_parent_id &&
					this_id != task_id
				   )
				{
					taskCheckParent(this_id);
				}
			});
		});
	}
}

function taskCheckParent(task_id)
{
	// Checking the parent_id

	// Getting level
	task_level = 0;
	$.each($('#task'+task_id + ' .level'), function () {
		task_level = parseInt($(this).text());
	});
	
	parent_id = 0;
	hit_task = false;
	task_children = new Array(); // Saving all children of our task

	// Running through all tasks
	$('#tasks td').each(function()
	{
	
		// Getting id
		this_id = 0;
		$.each($(this).children('.task'), function () {
			this_id = $(this).attr('id');
		});
		if(this_id == 0)
			return; // Error
		
		if(hit_task)
			return; // Already found result, no need to go further
		
		if(this_id == task_id)
		{
			// Last parent is parent
			hit_task = true;
			return;
		}
		
		// Getting level
		this_level = 0;
		$.each($(this).children('.level'), function () {
			this_level = parseInt($(this).text());
		});
		
		if(this_level < task_level)
		{
			// Possible parent
			$.each($(this).children('.task'), function () {
				parent_id = parseInt($(this).attr('id'));
			});
		}
	});

	if(!hit_task || parent_id == 0)
	{
		parent_id_set = false;
	}
	else
		parent_id_set = true;
	
	if(parent_id_set)
	{
		$('#task'+task_id+ ' .parent_id').text(parent_id);
		// TODO: database
	}
}
    </script>
<!--
        // do something
         // For example, you could place an AJAX call here:
        $.ajax({
          type: "POST",
          url: "some.php",
          data: "newfieldvalue=" + newValue,
          success: function(msg){
            alert( "Data Saved: " + msg );
          }
       });
-->
<style>
td {
 border: 1px solid black;
}

.level { background-color: lightblue; }
.id_display { background-color: pink; }
.parent_id { background-color: lightgreen; }
.task { border: 1px solid black; margin: 5px; padding: 5px; width: 400px;}
</style>
  </head>
  <body>
<div id="tester"></div>
<div class="level">Level</div>
<div class="id_display">Id</div>
<div class="parent_id">Parentid</div>
<table id="tasks">
	<tr id="task1"><td style="padding-left: 40px;"><div class="level">1</div><div class="id_display">1</div><div class="parent_id">0</div><div class="task" id="1" contenteditable="">Oppgave</div></td></tr>
	<tr id="task2"><td style="padding-left: 40px;"><div class="level">1</div><div class="id_display">2</div><div class="parent_id">0</div><div class="task" id="2" contenteditable="">Oppgave 2</div></td></tr>
</table>
    <a href="http://jquery.com/">jQuery</a>
  </body>
</html>
