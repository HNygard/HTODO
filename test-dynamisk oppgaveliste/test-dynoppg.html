<!doctype html>
<html>
  <head>
    <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="jquery-ui-1.8.1.custom.min.js"></script>

    <script type="text/javascript">
next_id = 3;
$(document).ready(function()
{
	$(".task").keyup(TaskKeyup);
	$(".task").keypress(TaskKeypress);
	/*$(".task").keydown(function(e)
	{
		//$("#tester").text(e.keyCode);
	});
	*/
});

function TaskKeyup (e)
{
	if(e.keyCode == 13) // Enter is pressed
	{
		// Getting level
		next_level = parseInt($('#task'+$(this).attr('id')+ ' .level').text());
		
		// Getting parent
		parent_id = parseInt($('#task'+$(this).attr('id')+ ' .parent_id').text());
		
		// Getting position
		position = parseInt($('#task'+$(this).attr('id')+ ' .position').text()) + 1;
		
		// Creating task in database and getting id 
		// TODO: database
		
		// In with the new task
		$('#task'+$(this).attr('id')).after('<li id="task'+next_id+'" '+
			'style="margin-left: '+(next_level*40)+'px;">'+
			'<div class="sorter">SORT</div>'+
			'<div class="level">'+next_level+'</div>'+
			'<div class="id_display">'+next_id+'</div>' +
			'<div class="parent_id">'+parent_id+'</div>' +
			'<div class="position">'+position+'</div>' +
			'<div '+
				// TODO: Change ID to something else
				'id="'+next_id+'" '+
				'class="task" '+
				'contenteditable=""'+
			'>Oppgave '+next_id+'</div></li>');
		
		$('#task'+next_id+' .task').keyup(TaskKeyup);
		$('#task'+next_id+' .task').keypress(TaskKeypress);
		$('#'+next_id).focus(); // TODO: change id for task edit field
		
		updateTask ();
		next_id++;
	}
	else if (e.keyCode == 9) // Tab is pressed
	{
		// Current id
		current_id = $(this).attr('id');
		
		// Finding level
		next_level = parseInt($('#task'+current_id+ ' .level').text());
		if(e.shiftKey)
		{
			if(next_level > 1) // 1 is the lowest level
				next_level--;
		}
		else
			next_level++;
		
		taskSetLevel(current_id, next_level);
	}
	else if (e.keyCode == 38 || e.keyCode == 40) // Up or down
	{
		found_focus = false;
		next = false;
		last_id = 0;
		
		// Find current id
		current_id = parseInt($(this).attr('id'));
		
		$('#tasks li').each(function()
		{
			if(found_focus)
				return;
			
			// Finding id for this task
			this_id = 0;
			$.each($(this).children('.task'), function () {
				this_id = $(this).attr('id');
			});
			if(this_id == 0)
				return; // Error
			
			if(next)
			{
				found_focus = true;
				$('#'+this_id).focus(); // TODO: change id for task edit field
			}
			
			if(e.keyCode == 38) // Up
			{
				if(this_id == current_id)
				{
					found_focus = true;
					$('#'+last_id).focus(); // TODO: change id for task edit field
				}
			}
			else // Down
			{
				if(this_id == current_id)
				{
					next = true;
				}
			}
			
			last_id = this_id;
		});
	}
	else
	{
		$("#tester").text(e.keyCode);
	}
}

function TaskKeypress(e)
{
	if(e.keyCode == 13 || e.keyCode == 9) {
		return false;
	}
}

function taskSetLevel (task_id, task_level)
{

	if(task_level >= 1)
	{
		$('#task'+task_id).css('margin-left', task_level*40+'px');
		$('#task'+task_id+ ' .level').text(task_level);
		
		updateTask();
	}
}

function updateTask ()
{
	last_level = -1;
	
	levels = new Array();
	levels_parent = new Array();
	positions = new Array();
	
	levels[0] = 1;
	levels_parent[0] = 0;
	positions[0] = 0;
	
	// Running through all tasks
	$('#tasks li').each(function()
	{
		// Getting id
		this_id = 0;
		$.each($(this).children('.task'), function () {
			this_id = $(this).attr('id');
		});
		if(this_id == 0)
			return; // Error
		
		// Getting level
		this_level = 0;
		$.each($(this).children('.level'), function () {
			this_level = parseInt($(this).text());
		});
		while(levels.length > 1 && levels[levels.length-1] > this_level-1)
		{
			levels.length--;
			levels_parent.length--;
			positions.length--;
		}
		
		// Is parent changed?
		this_parent_id = 0;
		$.each($(this).children('.parent_id'), function () {
			this_parent_id = parseInt($(this).text());
		});
		if(this_parent_id != levels_parent[levels_parent.length-1])
		{
			$('#task'+this_id+ ' .parent_id').text(levels_parent[levels_parent.length-1]);
			// TODO: database
			console.log('Task ' + this_id + ', parent_id: ' + levels_parent[levels_parent.length-1]);
		}
		
		// Is position changed?
		positions[levels.length-1]++;
		this_position = 0;
		$.each($(this).children('.position'), function () {
			this_position = parseInt($(this).text());
		});
		if(this_position != positions[levels.length-1])
		{
			$(this).children('.position').text(positions[levels.length-1]);
			// TODO: database
			console.log('Task ' + this_id + ', position: ' + positions[levels.length-1]);
		}
		
		// Setting parent for further use
		levels_parent[levels.length]  = this_id;
		positions[levels.length]      = 0;
		levels[levels.length]         = this_level;
	});
}
    </script>
<!--
        // do something
         // For example, you could place an AJAX call here:
        $.ajax({
          type: "POST",
          url: "some.php",
          data: "newfieldvalue=" + newValue,
          success: function(msg){
            alert( "Data Saved: " + msg );
          }
       });
-->
<style>
li {
 border: 1px solid black;
}

.level
{
	background-color: lightblue;
	display: none;
}
.id_display
{
	background-color: pink;
	width: 70px;
	float: right;
}
.parent_id
{
	background-color: lightgreen;
	width: 70px;
	float: right;
}
.position
{
	background-color: yellow;
	width: 70px;
	float: right;
}
.task { border: 1px solid black; margin: 5px; padding: 5px; width: 400px;}
</style>
<style type="text/css">
#tasks
{
	list-style-type: none;
	margin: 0;
	padding: 0;
	width: 60%;
}
#tasks li
{
	margin: 0 5px 5px 5px;
	padding: 5px;
	font-size: 1.2em;
	height: 1.5em;
}
html>body #tasks li
{
	height: 1.5em;
	line-height: 1.2em;
}
.ui-state-highlight
{
	height: 1.5em;
	line-height: 1.2em;
}
.sorter
{
	display: inline;
}
.task
{
	position: relative;
	top: 3px;
	display: inline;
}
</style>
<script type="text/javascript">
$(function() {
	$("#tasks").sortable({
		placeholder: 'ui-state-highlight',
		distance: 10,
		handle: 'div.sorter',
		update: function() {
			updateTask ();
		}
	});
	//$("#tasks").disableSelection();
});
</script>

  </head>
  <body>
<div id="tester"></div>
<div class="level">Level</div>
<div class="id_display">Id</div>
<div class="parent_id">Parentid</div>
<div class="position">Posisjon</div>
<ul id="tasks">
	<li id="task1" style="margin-left: 40px;"><div class="sorter">SORT</div><div class="level">1</div><div class="id_display">1</div><div class="parent_id">0</div><div class="position">1</div><div class="task" id="1" contenteditable="">Oppgave</div></li>
	<li id="task2" style="margin-left: 40px;"><div class="sorter">SORT</div><div class="level">1</div><div class="id_display">2</div><div class="parent_id">0</div><div class="position">2</div><div class="task" id="2" contenteditable="">Oppgave 2</div></li>
</ul>
    <a href="http://jquery.com/">jQuery</a>
  </body>
</html>
